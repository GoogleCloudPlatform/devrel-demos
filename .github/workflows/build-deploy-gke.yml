# Sources: 
  # https://github.com/google-github-actions/auth 
  name: 'Busybox - Test Build and deploy to GKE'

  on:
    push:
      branches:
        - "next25-aws-gcp-migration"
  
  defaults: 
    run:
      working-directory: './containers/aws-gcp-migration'
  
  env:
    PROJECT_ID: 'next25migration'  
    REGION: 'us-central1'
    GKE_CLUSTER: 'megan-test-cluster' 
    DEPLOYMENT_NAME: 'busybox'  
    REPOSITORY: 'megan-test-ar'  
    IMAGE: 'busybox'
  
  jobs:
    list-instances:
      runs-on: ubuntu-latest
  
      permissions:
        id-token: write # Required for workload identity federation
  
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
  
        - name: Authenticate to Google Cloud
          uses: google-github-actions/auth@v2
          with:
            credentials_json: ${{ secrets.GCP_SA_KEY }}
  
        - name: Set up Cloud SDK
          uses: google-github-actions/setup-gcloud@v2
  
        - name: 'Docker Auth'
          run: |-
            gcloud --quiet auth configure-docker
        
        - name: 'List Instances'
          run: |-
            gcloud compute instances list

        - name: 'Auth to GKE cluster' 
          run: |-
            gcloud components install gke-gcloud-auth-plugin
            gcloud container clusters get-credentials $GKE_CLUSTER --region $REGION --project $PROJECT_ID
  
        - name: 'Test access to GKE cluster'
          run: |-
            kubectl get pods --all-namespaces
            
        - name: 'Build and push container image'
          run: |-
            DOCKER_TAG="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${IMAGE}:${GITHUB_SHA}"
  
            docker build \
              --tag "${DOCKER_TAG}" \
              --build-arg GITHUB_SHA="${GITHUB_SHA}" \
              --build-arg GITHUB_REF="${GITHUB_REF}" \
              .
  
            docker push "${DOCKER_TAG}"
  
        - name: 'Deploy to GKE'
          run: |-
            kubectl run busybox --image=$REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:$GITHUB_SHA