# 1. Build Frontend
FROM node:22-alpine AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm install
COPY frontend/ .
RUN npm run build

# 2. Build Server
FROM golang:1.25.6-alpine AS server-builder
WORKDIR /app
COPY go.mod go.sum ./
COPY . .
# Copy scenarios for re-validation/context
COPY scenarios ./scenarios
COPY experiments/templates ./experiments/templates
RUN rm -f go.sum
RUN go mod tidy
RUN go build -o tenkai-server cmd/server/main.go

# 3. Runtime Stage
FROM alpine:3.19
WORKDIR /app
COPY --from=server-builder /app/tenkai-server .
COPY --from=server-builder /app/scenarios ./scenarios
COPY --from=server-builder /app/experiments/templates ./experiments/templates
# Copy static frontend files
COPY --from=frontend-builder /app/frontend/out ./static

# Install basic deps that might be needed (e.g. ca-certificates)
RUN apk add --no-cache ca-certificates

# Environment variables should be passed at runtime
ENV PORT=8080
ENV DB_DRIVER=pgx

EXPOSE 8080

CMD ["./tenkai-server", "--serve"]
